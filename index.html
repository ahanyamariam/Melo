<!DOCTYPE html>
<html lang="en">
<head>
  <script src="config.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Melo</title>
  <link href="https://fonts.googleapis.com/css2?family=Fasthand&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet"/>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      width: 292px;
      height: 460px;
      overflow: hidden;
      background: #F7C1F0;
      font-family: 'Nunito', sans-serif;
    }

    /* ── Screens ── */
    .screen { display: none; flex-direction: column; width: 292px; height: 460px; }
    .screen.active { display: flex; }

    
       /*PLAYER SCREEN*/
    
    #player-screen {
      background: #F7C1F0;
      padding: 36px 12px 10px 12px;
      gap: 7px;
    }

    
    .top-row {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
    }

    .genre-open-btn {
      background: #CC96BF;
      border: 2px solid #1a1a1a;
      box-shadow: 2px 2px 0px #1a1a1a;
      border-radius: 10px;
      width: 30px;
      height: 30px;
      font-size: 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: transform 0.1s;
    }
    .genre-open-btn:hover  { transform: scale(1.1); }
    .genre-open-btn:active { transform: scale(0.95); }

   
    .song-title-pill {
      flex: 1;
      background: #CC96BF;
      border-radius: 20px;
      padding: 6px 14px;
      text-align: center;
      border: 2px solid #1a1a1a;
      box-shadow: 3px 3px 0px #1a1a1a;
    }
    .song-title-pill span {
      font-family: 'Fasthand', cursive;
      font-size: 15px;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: block;
      text-shadow: 1px 1px 0px rgba(0,0,0,0.2);
    }

    
    .album-art-wrapper {
      border-radius: 14px;
      overflow: hidden;
      width: 100%;
      flex: 1;
      min-height: 0;
      position: relative;
      border: 2px solid #1a1a1a;
      box-shadow: 3px 3px 0px #1a1a1a;
    }
    .album-art-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      background: #f5e6a3;
    }
    .album-art-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #f5e6a3, #f0c060);
      font-size: 56px;
    }

    
    .artist-name {
      text-align: center;
      font-size: 11px;
      color: #7a3a60;
      font-weight: 700;
      flex-shrink: 0;
    }

    
    .progress-row {
      flex-shrink: 0;
      position: relative;
      height: 26px;
      margin: 0 2px;
    }
    .progress-bar-bg {
      position: absolute;
      left: 0; right: 0;
      top: 50%;
      transform: translateY(-50%);
      height: 8px;
      background: #DFA8D0;
      border-radius: 10px;
      cursor: pointer;
      border: 1.5px solid #1a1a1a;
      box-shadow: 2px 2px 0px #1a1a1a;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      background: #AA719F;
      border-radius: 10px;
      width: 0%;
    }
    .heart-thumb {
      position: absolute;
      top: 50%;
      left: 0%;
      transform: translate(-50%, -50%);
      width: 24px;
      height: 24px;
      cursor: grab;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3;
      user-select: none;
      filter: drop-shadow(1.5px 1.5px 0px #1a1a1a);
    }
    .heart-thumb:active { cursor: grabbing; }
    .heart-thumb svg { width: 22px; height: 22px; pointer-events: none; }

   
    .time-row {
      display: flex;
      justify-content: space-between;
      font-size: 10px;
      color: #7a3a60;
      font-weight: 600;
      padding: 0 2px;
      margin-top: -3px;
      flex-shrink: 0;
    }

   
    .status-msg {
      text-align: center;
      font-size: 10px;
      color: #7a3a60;
      font-style: italic;
      height: 13px;
      flex-shrink: 0;
      overflow: hidden;
    }

    
    .controls-panel {
      background: #CC96BF;
      border-radius: 14px;
      padding: 0 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      height: 62px;
      border: 2px solid #1a1a1a;
      box-shadow: 3px 3px 0px #1a1a1a;
    }
    .ctrl-btn {
      background: none;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.12s ease;
      padding: 0;
    }
    .ctrl-btn:hover  { transform: scale(1.1); }
    .ctrl-btn:active { transform: scale(0.93); }

    .play-pause-btn {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: #B085A7;
      border: 1px solid black;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      transition: transform 0.12s ease;
      box-shadow: 3px 3px 0px #1a1a1a;
      position: relative;
    }
    .play-pause-btn:hover  { transform: scale(1.06); }
    .play-pause-btn:active {
      transform: scale(0.96);
      box-shadow: inset 2px 2px 5px rgba(0,0,0,0.3), 1px 1px 0px #1a1a1a;
    }
    .play-pause-btn::before {
      content: '';
      position: absolute;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 1px solid black;
      background: white;
      z-index: 0;
    }
    .play-pause-btn svg {
      width: 18px;
      height: 18px;
      position: relative;
      z-index: 1;
    }

    /* 
       GENRE SCREEN */
    #genre-screen {
      background: #F7C1F0;
      padding: 12px;
      gap: 10px;
      padding: 36px 12px 10px 12px;
    }

    .genre-header {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }
    .genre-back-btn {
      background: #CC96BF;
      border: 2px solid #1a1a1a;
      box-shadow: 2px 2px 0px #1a1a1a;
      border-radius: 10px;
      width: 30px;
      height: 30px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: transform 0.1s;
    }
    .genre-back-btn:hover { transform: scale(1.1); }

    .genre-screen-title {
      font-family: 'Fasthand', cursive;
      font-size: 18px;
      color: #7a3a60;
    }

    /* Genre grid */
    .genre-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      overflow-y: auto;
      overflow-x: hidden;
      flex: 1;
      padding: 2px;
      align-content: start;
    }
    .genre-grid::-webkit-scrollbar { width: 4px; }
    .genre-grid::-webkit-scrollbar-thumb { background: #CC96BF; border-radius: 4px; }

    .genre-chip {
      background: #CC96BF;
      border: 2px solid #1a1a1a;
      box-shadow: 2px 2px 0px #1a1a1a;
      border-radius: 14px;
      padding: 10px 6px;
      font-family: 'Nunito', sans-serif;
      font-size: 11px;
      font-weight: 700;
      color: white;
      cursor: pointer;
      text-align: center;
      transition: transform 0.1s;
      transform-origin: center center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      min-width: 0;
      width: 100%;
    }
    .genre-chip:hover  { transform: scale(1.06); background: #b87aae; }
    .genre-chip:active { transform: scale(0.96); }
    .genre-chip.active {
      background: #7a3a60;
      color: #fff;
    }
    .genre-chip .genre-icon {
      width: 20px;
      height: 20px;
      color: white;
    }
    .genre-chip .genre-icon svg {
      width: 20px;
      height: 20px;
    }
  </style>
</head>
<body>

<!--  PLAYER SCREEN -->
<div id="player-screen" class="screen active">

  <div class="top-row">
    <button class="genre-open-btn" id="genre-open-btn" title="Pick a genre">
     
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 18V5l12-2v13"/>
        <circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>
      </svg>
    </button>
    <div class="song-title-pill">
      <span id="song-title">Loading music...</span>
    </div>
  </div>

  <div class="album-art-wrapper">
    <img id="album-art" src="" alt="Album Art" style="display:none;"/>
    <div class="album-art-placeholder" id="art-placeholder">
      <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#c0903a" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 18V5l12-2v13"/>
        <circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>
      </svg>
    </div>
  </div>

  <div class="artist-name" id="artist-name">—</div>

  <div class="progress-row">
    <div class="progress-bar-bg" id="progress-bg">
      <div class="progress-bar-fill" id="progress-fill"></div>
    </div>
    <div class="heart-thumb" id="heart-thumb">
      <svg viewBox="0 0 24 22" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 20.5C12 20.5 1.5 13.5 1.5 7C1.5 4.015 3.515 1.5 6.5 1.5C8.5 1.5 10.26 2.61 11.5 4.27C12.74 2.61 14.5 1.5 16.5 1.5C19.485 1.5 22.5 4.015 22.5 7C22.5 13.5 12 20.5 12 20.5Z"
          fill="#AA719F" stroke="#1a1a1a" stroke-width="1.5"/>
      </svg>
    </div>
  </div>

  <div class="time-row">
    <span id="time-current">0:00</span>
    <span id="time-total">0:00</span>
  </div>

  <div class="status-msg" id="status-msg"></div>

  <div class="controls-panel">
    <button class="ctrl-btn" id="prev-btn">
      <svg width="44" height="36" viewBox="0 0 44 36" fill="none">
        <path d="M22 4 L6 18 L22 32 Z"  fill="white" stroke="black" stroke-width="1" stroke-linejoin="round" stroke-linecap="round"/>
        <path d="M36 4 L20 18 L36 32 Z" fill="white" stroke="black" stroke-width="1" stroke-linejoin="round" stroke-linecap="round"/>
      </svg>
    </button>

    <div class="play-pause-btn" id="play-pause-btn">
      <svg id="play-icon" viewBox="0 0 30 30" fill="none">
        <polygon points="9,4 26,15 9,26" fill="#B085A7" stroke="#1a1a1a" stroke-width="2" stroke-linejoin="round"/>
      </svg>
      <svg id="pause-icon" viewBox="0 0 30 30" fill="none" style="display:none;">
        <rect x="5"  y="4" width="7" height="22" rx="3.5" fill="#B085A7" stroke="#1a1a1a" stroke-width="1"/>
        <rect x="18" y="4" width="7" height="22" rx="3.5" fill="#B085A7" stroke="#1a1a1a" stroke-width="1"/>
      </svg>
    </div>

    <button class="ctrl-btn" id="next-btn">
      <svg width="44" height="36" viewBox="0 0 44 36" fill="none">
        <path d="M8 4 L24 18 L8 32 Z"   fill="white" stroke="black" stroke-width="1" stroke-linejoin="round" stroke-linecap="round"/>
        <path d="M22 4 L38 18 L22 32 Z" fill="white" stroke="black" stroke-width="1" stroke-linejoin="round" stroke-linecap="round"/>
      </svg>
    </button>
  </div>
</div>

<!--  GENRE SCREEN -->
<div id="genre-screen" class="screen">
  <div class="genre-header">
    <button class="genre-back-btn" id="genre-back-btn">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="15 18 9 12 15 6"/>
      </svg>
    </button>
    <span class="genre-screen-title">Pick a Genre ≽^• ˕ • ྀི≼</span>
  </div>

  <div class="genre-grid" id="genre-grid"></div>
</div>

<audio id="audio-player"></audio>

<script>
  //  CONFIG 
  const CLIENT_ID = window.JAMENDO_CLIENT_ID;
  const API_BASE  = 'https://api.jamendo.com/v3.0';

  //  GENRES 
  const GENRES = [
    { label: 'Pop',        tag: 'pop',       icon: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 0 20A10 10 0 0 0 12 2z"/><path d="M12 8v8M8 12h8"/></svg>` },
    { label: 'Rock',       tag: 'rock',      icon: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9l-6-6z"/><polyline points="9 3 9 9 15 9"/></svg>` },
    { label: 'Jazz',       tag: 'jazz',      icon: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 18v-6a9 9 0 0 1 18 0v6"/><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3v5z"/><path d="M3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3v5z"/></svg>` },
    { label: 'Electronic', tag: 'electronic',icon: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>` },
    { label: 'Hip-Hop',    tag: 'hiphop',    icon: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>` },
    { label: 'Classical',  tag: 'classical', icon: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>` },
    { label: 'Folk',       tag: 'folk',      icon: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>` },
    { label: 'Ambient',    tag: 'ambient',   icon: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>` },
    { label: 'Indie',      tag: 'indie',     icon: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>` },
    { label: 'R&B',        tag: 'rnb',       icon: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>` },
    { label: 'Lounge',     tag: 'lounge',    icon: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>` },
    { label: 'Acoustic',   tag: 'acoustic',  icon: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>` },
    { label: 'Chill',      tag: 'chillout',  icon: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/></svg>` },
    { label: 'Country',    tag: 'country',   icon: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 17l4-8 4 4 4-6 4 10"/><line x1="3" y1="21" x2="21" y2="21"/></svg>` },
    { label: 'Dance',      tag: 'dance',     icon: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="4" r="2"/><path d="M9 20l3-9 3 9"/><path d="M6 9l6 2 6-2"/></svg>` },
  ];

  let currentTag   = '';  
  let tracks       = [];
  let currentIndex = 0;
  let isPlaying    = false;
  let isScrubbing  = false;

  //  DOM 
  const audio          = document.getElementById('audio-player');
  const songTitle      = document.getElementById('song-title');
  const artistName     = document.getElementById('artist-name');
  const albumArt       = document.getElementById('album-art');
  const artPlaceholder = document.getElementById('art-placeholder');
  const progressFill   = document.getElementById('progress-fill');
  const progressBg     = document.getElementById('progress-bg');
  const heartThumb     = document.getElementById('heart-thumb');
  const timeCurrent    = document.getElementById('time-current');
  const timeTotal      = document.getElementById('time-total');
  const playPauseBtn   = document.getElementById('play-pause-btn');
  const playIcon       = document.getElementById('play-icon');
  const pauseIcon      = document.getElementById('pause-icon');
  const prevBtn        = document.getElementById('prev-btn');
  const nextBtn        = document.getElementById('next-btn');
  const statusMsg      = document.getElementById('status-msg');
  const genreOpenBtn   = document.getElementById('genre-open-btn');
  const genreBackBtn   = document.getElementById('genre-back-btn');
  const genreGrid      = document.getElementById('genre-grid');

  //  SCREENS 
  function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }

  genreOpenBtn.addEventListener('click', () => showScreen('genre-screen'));
  genreBackBtn.addEventListener('click', () => showScreen('player-screen'));

  //  BUILD GENRE GRID 
  GENRES.forEach(g => {
    const chip = document.createElement('button');
    chip.className = 'genre-chip';
    chip.innerHTML = `<span class="genre-icon">${g.icon}</span>${g.label}`;
    if (g.tag === currentTag) chip.classList.add('active');
    chip.addEventListener('click', () => {
      currentTag = g.tag;
      // Mark active
      document.querySelectorAll('.genre-chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      // Load tracks for this genre and go back to player
      fetchTracks(g.tag);
      showScreen('player-screen');
    });
    genreGrid.appendChild(chip);
  });

  //  FETCH TRACKS 
  async function fetchTracks(tag = '') {
    try {
      setStatus(tag ? `Loading ${tag}...` : 'Loading music...');
      songTitle.textContent = tag ? `Loading ${tag}...` : 'Loading music...';

      let url = `${API_BASE}/tracks/?client_id=${CLIENT_ID}&format=json&limit=20&include=musicinfo&audioformat=mp32&order=popularity_total`;
      if (tag) url += `&tags=${encodeURIComponent(tag)}`;

      const res  = await fetch(url);
      const data = await res.json();

      if (data.results && data.results.length > 0) {
        tracks = data.results.filter(t => t.audio);
        if (!tracks.length) { setStatus('No playable tracks found.'); return; }
        setStatus('');
       
        audio.pause();
        isPlaying = false;
        playIcon.style.display  = 'block';
        pauseIcon.style.display = 'none';
        loadTrack(0);
      } else {
        setStatus('No tracks found for this genre.');
        songTitle.textContent = 'No tracks found';
      }
    } catch (err) {
      setStatus('Could not connect to Jamendo.');
      console.error(err);
    }
  }

  //  LOAD TRACK 
  function loadTrack(index) {
    currentIndex = index;
    const track  = tracks[index];
    songTitle.textContent  = track.name;
    artistName.textContent = track.artist_name;
    audio.src              = track.audio;

    if (track.album_image || track.image) {
      albumArt.src = track.album_image || track.image;
      albumArt.style.display = 'block';
      artPlaceholder.style.display = 'none';
      albumArt.onerror = () => { albumArt.style.display = 'none'; artPlaceholder.style.display = 'flex'; };
    } else {
      albumArt.style.display = 'none';
      artPlaceholder.style.display = 'flex';
    }

    setProgress(0);
    timeCurrent.textContent = '0:00';
    timeTotal.textContent   = '0:00';
    if (isPlaying) audio.play().catch(() => {});
  }

  //  PLAY / PAUSE 
  function togglePlayPause() {
    if (!tracks.length) return;
    isPlaying ? audio.pause() : audio.play().catch(() => setStatus('Playback blocked.'));
  }

  audio.addEventListener('play',  () => { isPlaying = true;  playIcon.style.display = 'none';  pauseIcon.style.display = 'block'; });
  audio.addEventListener('pause', () => { isPlaying = false; playIcon.style.display = 'block'; pauseIcon.style.display = 'none';  });
  audio.addEventListener('ended', () => nextTrack());

  //  PROGRESS 
  function setProgress(pct) {
    pct = Math.max(0, Math.min(1, pct));
    progressFill.style.width = (pct * 100) + '%';
    heartThumb.style.left    = (pct * 100) + '%';
  }

  audio.addEventListener('timeupdate', () => {
    if (isScrubbing || !audio.duration) return;
    setProgress(audio.currentTime / audio.duration);
    timeCurrent.textContent = formatTime(audio.currentTime);
    timeTotal.textContent   = formatTime(audio.duration);
  });

  function pctFromEvent(e) {
    const rect = progressBg.getBoundingClientRect();
    return Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
  }
  function doScrub(e) {
    const pct = pctFromEvent(e);
    setProgress(pct);
    if (audio.duration) {
      audio.currentTime = pct * audio.duration;
      timeCurrent.textContent = formatTime(audio.currentTime);
    }
  }

  progressBg.addEventListener('mousedown', e => { isScrubbing = true; doScrub(e); });
  heartThumb.addEventListener('mousedown', e => { isScrubbing = true; e.preventDefault(); });
  document.addEventListener('mousemove',   e => { if (isScrubbing) doScrub(e); });
  document.addEventListener('mouseup',     () => { isScrubbing = false; });

  //  SKIP 
  function nextTrack() {
    if (!tracks.length) return;
    loadTrack((currentIndex + 1) % tracks.length);
    if (isPlaying) audio.play().catch(() => {});
  }
  function prevTrack() {
    if (!tracks.length) return;
    if (audio.currentTime > 3) { audio.currentTime = 0; return; }
    loadTrack((currentIndex - 1 + tracks.length) % tracks.length);
    if (isPlaying) audio.play().catch(() => {});
  }

  playPauseBtn.addEventListener('click', togglePlayPause);
  nextBtn.addEventListener('click', nextTrack);
  prevBtn.addEventListener('click', prevTrack);

  //  HELPERS 
  function formatTime(s) {
    if (isNaN(s) || s < 0) return '0:00';
    const m   = Math.floor(s / 60);
    const sec = Math.floor(s % 60).toString().padStart(2, '0');
    return `${m}:${sec}`;
  }
  function setStatus(msg) { statusMsg.textContent = msg; }

fetchTracks();

</script>
</body>
</html>